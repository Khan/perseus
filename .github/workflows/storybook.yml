name: Publish Storybook to Chromatic

on:
    workflow_dispatch:
    push:
        paths:
            - "packages/**"

# When a new revision is pushed to a PR, cancel all in-progress CI runs for that
# PR. See https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    chromatic:
        name: Publish Storybook to Chromatic
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest]
                node-version: [20.x]
        steps:
            # chromaui/@action doesn't work with shallow checkouts which is the
            # default for actions/checkout so we need to force it to checkout
            # more stuff.
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install & cache node_modules
              uses: ./.github/actions/shared-node-cache
              with:
                  node-version: ${{ matrix.node-version }}
                  ssh-private-key: ${{ secrets.KHAN_ACTIONS_BOT_SSH_PRIVATE_KEY }}

            - name: Publish to Chromatic
              uses: chromaui/action@v11
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  projectToken: ${{ secrets.CHROMATIC_APP_CODE }}
                  autoAcceptChanges: "main"
                  onlyStoryFiles:
                      # TODO(benchristel): currently the list of story files to
                      # regression-test is hardcoded. In the future we may want
                      # to establish a convention, e.g. testing story files with
                      # `.chromatic.` in their name.
                      - packages/perseus/src/widgets/__stories__/interactive-graph-regression.stories.tsx
