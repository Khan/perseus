import{a as U}from"./version-akiLXZts.js";import{j as l,a as S}from"./jsx-runtime-BGVbfQ2Z.js";import{C as x}from"./index-hYQ6Pa3_.js";import{_ as $}from"./index-V35CFGao.js";import{e as Y}from"./index-J2t_5nK1.js";import{l as X}from"./index-awljIyHI.js";import{r as H}from"./index-qhcEwEpg.js";import{R as B}from"./index-E09jvG0x.js";import{a as j,V as z}from"./index-k9JCoeOY.js";import{m as u,i as G,s as _,a as J,b as N,e as Z,f as tt,M as g,h as b,j as R,c as et,l as nt,g as ot,k as st,n as it}from"./key-translator-NuuNqL6m.js";import{g as rt}from"./_commonjsHelpers-4gQjN7DL.js";const at="@khanacademy/math-input",ct="__lib_version__";U(at,ct);const w=11,A=1.045,D=2*w,dt=2*D,F=2*D,K=w,L=A*(K*4),P=4*K,M=class M extends H.Component{render(){const{x:t,y:e,animateIntoPosition:o}=this.props,n=o?{transitionDuration:"100ms",transitionProperty:"transform"}:{},i=`translate(${t}px, ${e}px)`,a={position:"absolute",zIndex:4,left:-F/2,top:0,transform:i,width:F,height:dt,touchAction:"none",...n};return l("span",{style:a,onTouchStart:this.props.onTouchStart,onTouchMove:this.props.onTouchMove,onTouchEnd:this.props.onTouchEnd,onTouchCancel:this.props.onTouchCancel,children:S("svg",{fill:"none",width:P,height:L,viewBox:`0 0 ${P} ${L}`,children:[S("filter",{id:"math-input_cursor",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",height:L*.87,width:P*.82,x:"4",y:"0",children:[l("feFlood",{floodOpacity:"0",result:"BackgroundImageFix"}),l("feColorMatrix",{in:"SourceAlpha",type:"matrix",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"}),l("feOffset",{dy:"4"}),l("feGaussianBlur",{stdDeviation:"4"}),l("feColorMatrix",{type:"matrix",values:"0 0 0 0 0.129412 0 0 0 0 0.141176 0 0 0 0 0.172549 0 0 0 0.08 0"}),l("feBlend",{in2:"BackgroundImageFix",mode:"normal",result:"effect1_dropShadow"}),l("feBlend",{in:"SourceGraphic",in2:"effect1_dropShadow",mode:"normal",result:"shape"})]}),l("g",{filter:"url(#math-input_cursor)",children:l("path",{d:"m22 4-7.07 7.0284c-1.3988 1.3901-2.3515 3.1615-2.7376 5.09-.3861 1.9284-.1883 3.9274.5685 5.7441s2.0385 3.3694 3.6831 4.4619c1.6445 1.0925 3.5781 1.6756 5.556 1.6756s3.9115-.5831 5.556-1.6756c1.6446-1.0925 2.9263-2.6452 3.6831-4.4619s.9546-3.8157.5685-5.7441c-.3861-1.9285-1.3388-3.6999-2.7376-5.09z",fill:"#1865f2"})}),l("path",{d:"m14.9301 10.4841 7.0699-7.06989 7.0699 7.06989.0001.0001c1.3988 1.3984 2.3515 3.1802 2.7376 5.1201s.1883 3.9507-.5685 5.7782c-.7568 1.8274-2.0385 3.3894-3.6831 4.4883-1.6445 1.099-3.5781 1.6855-5.556 1.6855s-3.9115-.5865-5.556-1.6855c-1.6446-1.0989-2.9263-2.6609-3.6831-4.4883-.7568-1.8275-.9546-3.8383-.5685-5.7782s1.3388-3.7217 2.7376-5.1201z",stroke:"#fff",strokeWidth:"2"})]})})}};M.defaultProps={animateIntoPosition:!1,visible:!1,x:0,y:0};let T=M;try{T.displayName="CursorHandle",T.__docgenInfo={description:"",displayName:"CursorHandle",props:{animateIntoPosition:{defaultValue:{value:"false"},description:"",name:"animateIntoPosition",required:!1,type:{name:"boolean"}},onTouchCancel:{defaultValue:null,description:"",name:"onTouchCancel",required:!0,type:{name:"(arg1: TouchEvent<HTMLSpanElement>) => void"}},onTouchEnd:{defaultValue:null,description:"",name:"onTouchEnd",required:!0,type:{name:"(arg1: TouchEvent<HTMLSpanElement>) => void"}},onTouchMove:{defaultValue:null,description:"",name:"onTouchMove",required:!0,type:{name:"(arg1: TouchEvent<HTMLSpanElement>) => void"}},onTouchStart:{defaultValue:null,description:"",name:"onTouchStart",required:!0,type:{name:"(arg1: TouchEvent<HTMLSpanElement>) => void"}},visible:{defaultValue:{value:"false"},description:"",name:"visible",required:!1,type:{name:"boolean"}},x:{defaultValue:{value:"0"},description:"",name:"x",required:!1,type:{name:"number"}},y:{defaultValue:{value:"0"},description:"",name:"y",required:!1,type:{name:"number"}}}}}catch{}const I=8;class lt{constructor(t,e){this._scrollListener=()=>{t()};const o={};for(let n=0;n<e.changedTouches.length;n++){const i=e.changedTouches[n];o[i.identifier]=[i.clientX,i.clientY]}this._moveListener=n=>{for(let i=0;i<n.changedTouches.length;i++){const a=n.changedTouches[i],c=o[a.identifier];if(c){const r=[a.clientX,a.clientY],d=r[0]-c[0],p=r[1]-c[1],C=d*d+p*p,v=I*I;C>v&&t()}}},this._endAndCancelListener=n=>{for(let i=0;i<n.changedTouches.length;i++)delete o[n.changedTouches[i].identifier]}}attach(){window.addEventListener("scroll",this._scrollListener),window.addEventListener("touchmove",this._moveListener),window.addEventListener("touchend",this._endAndCancelListener),window.addEventListener("touchcancel",this._endAndCancelListener)}detach(){window.removeEventListener("scroll",this._scrollListener),window.removeEventListener("touchmove",this._moveListener),window.removeEventListener("touchend",this._endAndCancelListener),window.removeEventListener("touchcancel",this._endAndCancelListener)}}function ht(s,t){const e=t[u.L]===g.MQ_END,o=b(t.parent.parent.blocks[0].ends);e?(_(t.parent.parent,t),o&&s.keystroke("Backspace")):s.keystroke("Backspace")}function ut(s,t){if(b(t)){const e=t.parent.parent,o=e.latex(),n=e[u.L];_(e,t),e.blocks[1]._el.textContent===""?s.keystroke("Backspace"):(s.keystroke("Backspace"),s.write(o.replace(/^\\sqrt\[\]/,"\\sqrt")),n===g.MQ_END?s.moveToLeftEnd():t.insRightOf(n))}else t[u.L]!==g.MQ_END&&s.keystroke("Backspace")}function pt(s,t){if(b(t)){const e=t.parent.parent,o=R(e);t.insLeftOf(o==null?void 0:o.startNode),t.startSelection(),e[u.R]!==g.MQ_END?t.insRightOf(e[u.R]):t.insRightOf(e),t.select(),t.endSelection(),e[u.R]._el.textContent===""&&s.keystroke("Backspace")}else s.keystroke("Backspace")}function ft(s){const t=s[u.L],e=s[u.R],o=R(t);o&&o.startNode?(s.insLeftOf(o.startNode),s.startSelection(),e===g.MQ_END?s.insAtRightEnd(s.parent):s.insLeftOf(e),s.select(),s.endSelection()):(s.startSelection(),s.insLeftOf(t),s.select(),s.endSelection())}function mt(s,t){if(t[u.L]!==g.MQ_END){s.keystroke("Backspace");return}const e=t.parent.parent;if(e[u.L].sub&&e[u.L].sub._el.textContent){t.insAtRightEnd(e[u.L].sub);return}const o=b(t),n=R(e);t.insLeftOf(n&&n.startNode||e),t.startSelection(),t.insRightOf(e),t.select(),t.endSelection(),o&&s.keystroke("Backspace")}function gt(s){s.keystroke("Backspace"),s.keystroke("Backspace")}function yt(s){const t=s.cursor();if(t.selection)s.keystroke("Backspace");else{const e=t.parent,o=e.parent,n=t[u.L];G(n)?_(n,t):J(n)?_(n,t):N(n)?_(n,t):Z(e)?ut(s,t):n.ctrlSeq==="\\left("?ft(t):o.ctrlSeq==="\\left("?mt(s,t):tt(t)?pt(s,t):n.ctrlSeq==="\\ge "||n.ctrlSeq==="\\le "?gt(s):N(o)&&n===g.MQ_END?ht(s,t):s.keystroke("Backspace")}}const Ct={...st,BACKSPACE:yt};class _t{constructor(t,e={}){this.mathField=et(t,()=>({substituteTextarea:function(){return document.createElement("span")}})),this.callbacks=e}focus(){this.mathField.cursor().show(),this.mathField.focus()}blur(){this.mathField.cursor().hide(),this.mathField.blur()}pressKey(t){const e=this.getCursor(),o=Ct[t];return o&&o(this.mathField,t),e.selection||e.show(),this.callbacks.onSelectionChanged&&this.callbacks.onSelectionChanged(e.selection),{context:this.contextForCursor()}}setCursorPosition(t,e,o){const n=o||document.elementFromPoint(t,e);if(n){const i=this.getCursor();if(n.hasAttribute("mq-root-block"))i.insAtRightEnd(this.mathField.controller().root);else{const a=this.mathField.controller(),c=t-document.body.scrollLeft,r=e-document.body.scrollTop;a.seek(n,c,r).cursor.startSelection();const d=nt(i[u.L]);d&&d.endNode&&(i.insLeftOf(d.endNode),this.mathField.keystroke("Right"))}this.callbacks.onCursorMove&&this.callbacks.onCursorMove({context:this.contextForCursor()})}}getCursor(){return this.mathField.cursor()}contextForCursor(){return ot(this.mathField)}getSelection(){return this.getCursor().selection}getContent(){return this.mathField.latex()}setContent(t){this.mathField.latex(t)}isEmpty(){const t=this.getCursor();return t.parent.id===1&&t[1]===0&&t[-1]===0}}const Tt=60,vt=(s,t)=>{const e=s.getBoundingClientRect(),o=e.bottom,n=e.top,i=document.scrollingElement,a=16;if(t){const c=window.innerHeight,r=t.clientHeight,d=c-(r+Tt);if(o>d){const p=Math.min(o-d+a,n);i&&(i.scrollTop+=p);return}}i&&n<a&&(i.scrollTop-=e.height+a)},q=.8,O=class O extends H.Component{constructor(){super(...arguments),this.state={focused:!1,handle:{animateIntoPosition:!1,visible:!1,x:0,y:0}},this._updateInputPadding=()=>{this._container=B.findDOMNode(this),this._root=this._container.querySelector(".mq-root-block");const t=this.getInputInnerPadding();this._root.style.padding=`${t.paddingTop}px ${t.paddingRight}px ${t.paddingBottom}px ${t.paddingLeft}px`,this._root.style.fontSize=`${kt}pt`},this._updateCursorHandle=t=>{const e=this._container.getBoundingClientRect(),n=this._container.querySelector(".mq-cursor").getBoundingClientRect(),i=n.width,a=2,c=this.getInputInnerPadding(),r=e.right-i-c.paddingRight,d=e.left+i+c.paddingLeft;let p=n.left;n.left>r?p=r:n.left<d&&(p=d),this.setState({handle:{visible:!0,animateIntoPosition:t,x:p+i/2-e.left,y:n.bottom+a-e.top}})},this._hideCursorHandle=()=>{this.setState({handle:{visible:!1,x:0,y:0}})},this._handleScroll=()=>{this.state.handle.animateIntoPosition!==!1&&this._hideCursorHandle()},this.blur=()=>{this.mathField.blur(),this.props.onBlur&&this.props.onBlur(),this.setState({focused:!1,handle:{visible:!1}})},this.focus=()=>{var t,e;(t=this.props.keypadElement)==null||t.setKeyHandler(o=>{const n=this.mathField.pressKey(o),i=()=>{this.setState({handle:{visible:!1}})},a=this.mathField.getContent();return this.props.value!==a?this.props.onChange(a,i):i(),n}),this.mathField.focus(),(e=this.props)==null||e.onFocus(),this.setState({focused:!0},()=>{setTimeout(()=>{var o;if(this._isMounted){const n=(o=this.props.keypadElement)==null?void 0:o.getDOMNode();vt(this._container,n)}})})},this._findHitNode=(t,e,o,n,i)=>{for(;o>=t.top&&o<=t.bottom;){o+=i;const c=[[e-n,o],[e,o],[e+n,o]].map(h=>document.elementFromPoint(...h)).filter(h=>h&&this._root.contains(h)&&(!h.classList.contains("mq-root-block")&&!h.classList.contains("mq-non-leaf")||h.classList.contains("mq-empty")||h.classList.contains("mq-hasCursor")));let r=null;const d=[];let p=0;const C={},v={};for(const h of c){const f=h.getAttribute("mathquill-command-id");f!=null?(C[f]=(C[f]||0)+1,v[f]=h):d.push(h)}for(const[h,f]of Y(C))f>p&&(p=f,r=v[h]);if(r==null&&d.length>0&&(r=d[0]),r!==null)return this.mathField.setCursorPosition(e,o,r),!0}return!1},this._insertCursorAtClosestNode=(t,e)=>{const o=this.mathField.getCursor();if(!this._root.hasChildNodes()){o.insAtLeftEnd(this.mathField.mathField.controller().root);return}e>this._containerBounds.bottom?e=this._containerBounds.bottom-10:e<this._containerBounds.top&&(e=this._containerBounds.top+10),t>this._containerBounds.right?t=this._containerBounds.right-15:t<this._containerBounds.left&&(t=this._containerBounds.left+15);let n;n=-8;const i=5;if(this._findHitNode(this._containerBounds,t,e,i,n)||(e=this._containerBounds.top,n=8,this._findHitNode(this._containerBounds,t,e,i,n)))return;const a=this._root.firstChild.getBoundingClientRect(),c=this._root.lastChild.getBoundingClientRect(),r=a.left,d=c.right;Math.abs(t-d)<Math.abs(t-r)?o.insAtRightEnd(this.mathField.mathField.controller().root):o.insAtLeftEnd(this.mathField.mathField.controller().root),this.props.keypadElement&&this.props.keypadElement.setCursor({context:this.mathField.contextForCursor()})},this.handleTouchStart=(t,e,o)=>{var n;if(t.stopPropagation(),this._hideCursorHandle(),this.mathField.getContent()!==""){this._containerBounds=this._container.getBoundingClientRect();const i=t.changedTouches[0];this._insertCursorAtClosestNode(i.clientX,i.clientY)}this.state.focused&&!e&&o(!0),this.state.focused||this.focus(),(n=this.inputRef)==null||n.focus()},this.handleClick=(t,e,o)=>{var n;t.stopPropagation(),this._hideCursorHandle(),this.mathField.getContent()!==""&&(this._containerBounds=this._container.getBoundingClientRect(),this._insertCursorAtClosestNode(t.clientX,t.clientY)),this.state.focused&&!e&&o(!0),this.state.focused||this.focus(),(n=this.inputRef)==null||n.focus()},this.handleTouchMove=t=>{if(t.stopPropagation(),this.mathField.getContent()!==""&&this.state.focused){const e=t.changedTouches[0];this._insertCursorAtClosestNode(e.clientX,e.clientY)}},this.handleTouchEnd=t=>{t.stopPropagation(),this.mathField.getContent()!==""&&this.state.focused&&this._updateCursorHandle()},this.onCursorHandleTouchStart=t=>{t.stopPropagation(),t.preventDefault(),this._containerBounds=this._container.getBoundingClientRect()},this._constrainToBound=(t,e,o,n)=>t<e?e+(t-e)*n:t>o?o+(t-o)*n:t,this.onCursorHandleTouchMove=t=>{t.stopPropagation();const e=t.changedTouches[0].clientX,o=t.changedTouches[0].clientY,n=e-this._containerBounds.left,i=o-2*w*A-this._containerBounds.top;this.setState({handle:{animateIntoPosition:!1,visible:!0,x:this._constrainToBound(n,0,this._containerBounds.width,q),y:this._constrainToBound(i,0,this._containerBounds.height,q)}});const c=o-22;this._insertCursorAtClosestNode(e,c)},this.onCursorHandleTouchEnd=t=>{t.stopPropagation(),this._updateCursorHandle(!0)},this.onCursorHandleTouchCancel=t=>{t.stopPropagation(),this._updateCursorHandle(!0)},this.domKeyToMathQuillKey=t=>{const e={"+":"PLUS","-":"MINUS","*":"TIMES","/":"DIVIDE",".":"DECIMAL","%":"PERCENT","=":"EQUAL",">":"GT","<":"LT","^":"EXP"};return["0","1","2","3","4","5","6","7","8","9"].includes(t)?`NUM_${t}`:t==="Backspace"?"BACKSPACE":t in e?e[t]:null},this.handleKeyUp=t=>{const e=this.domKeyToMathQuillKey(t.key);if(e){this.mathField.pressKey(e);const o=this.mathField.getContent();this.props.value!==o&&(this.mathField.setContent(this.props.value),this.props.onChange(o,()=>{}),this._hideCursorHandle())}},this.getBorderWidthPx=()=>this.state.focused?2:1,this.getInputInnerPadding=()=>{const t=V-this.getBorderWidthPx();return{paddingTop:t-1,paddingRight:t,paddingBottom:t-3,paddingLeft:t}}}componentDidMount(){this._isMounted=!0,this.mathField=new _t(this._mathContainer,{onCursorMove:e=>{this.props.keypadElement&&this.props.keypadElement.setCursor(e)}}),this.mathField.setContent(this.props.value),this._updateInputPadding(),this._container=B.findDOMNode(this),this._root=this._container.querySelector(".mq-root-block"),this._root.addEventListener("scroll",this._handleScroll);const t=(e,o)=>{const n=this._getKeypadBounds();return n?n.left<=e&&n.right>=e&&n.top<=o&&n.bottom>=o||n.bottom<o:!1};this.recordTouchStartOutside=e=>{if(this.state.focused&&!this._container.contains(e.target)){let o=!1;if(this.props.keypadElement&&this.props.keypadElement.getDOMNode())for(let n=0;n<e.changedTouches.length;n++){const[i,a]=[e.changedTouches[n].clientX,e.changedTouches[n].clientY];if(t(i,a)){o=!0;break}}o||(this.didTouchOutside=!0,this.dragListener&&this.dragListener.detach(),this.dragListener=new lt(()=>{this.didScroll=!0,this.dragListener.detach()},e),this.dragListener.attach())}},this.blurOnTouchEndOutside=e=>{this.state.focused&&this.didTouchOutside&&!this.didScroll&&this.blur(),this.didTouchOutside=!1,this.didScroll=!1,this.dragListener&&this.dragListener.detach()},this.blurOnClickOutside=e=>{if(this.state.focused&&!this._container.contains(e.target)&&this.props.keypadElement&&this.props.keypadElement.getDOMNode()){const[o,n]=[e.clientX,e.clientY];t(o,n)||this.blur()}},window.addEventListener("touchstart",this.recordTouchStartOutside),window.addEventListener("touchend",this.blurOnTouchEndOutside),window.addEventListener("touchcancel",this.blurOnTouchEndOutside),window.addEventListener("click",this.blurOnClickOutside)}componentDidUpdate(t,e){this.mathField.getContent()!==this.props.value&&this.mathField.setContent(this.props.value),e.focused!==this.state.focused&&this._updateInputPadding()}componentWillUnmount(){this._isMounted=!1,window.removeEventListener("touchstart",this.recordTouchStartOutside),window.removeEventListener("touchend",this.blurOnTouchEndOutside),window.removeEventListener("touchcancel",this.blurOnTouchEndOutside),window.removeEventListener("click",this.blurOnClickOutside)}_getKeypadBounds(){var e;const t=(e=this.props.keypadElement)==null?void 0:e.getDOMNode();return t instanceof Element?t.getBoundingClientRect():null}render(){const{focused:t,handle:e}=this.state,{style:o}=this.props,n={...Pt.innerContainer,borderWidth:this.getBorderWidthPx(),...t?{borderColor:x.blue}:{},...o},i=it.mathInputBox+" "+$("Tap with one or two fingers to open keyboard");return l(j.Consumer,{children:({keypadActive:a,setKeypadActive:c})=>S(z,{style:Lt.input,onTouchStart:r=>{this.handleTouchStart(r,a,c)},onTouchMove:this.handleTouchMove,onTouchEnd:this.handleTouchEnd,onClick:r=>{this.handleClick(r,a,c)},role:"textbox",ariaLabel:i,children:[l("div",{className:"keypad-input",tabIndex:"0",ref:r=>{this.inputRef=r},onKeyUp:this.handleKeyUp,children:l("div",{ref:r=>{this._mathContainer=B.findDOMNode(r)},style:n})}),t&&e.visible&&l(T,{...e,onTouchStart:this.onCursorHandleTouchStart,onTouchMove:this.onCursorHandleTouchMove,onTouchEnd:this.onCursorHandleTouchEnd,onTouchCancel:this.onCursorHandleTouchCancel})]})})}};O.defaultProps={style:{},value:""};let k=O;const kt=18,W=128,bt=20,V=12,Et=bt+V*2,Bt=64,Lt=X.StyleSheet.create({input:{position:"relative",display:"inline-block",verticalAlign:"middle",maxWidth:W}}),Pt={innerContainer:{backgroundColor:"white",minHeight:Et,minWidth:Bt,maxWidth:W,boxSizing:"border-box",position:"relative",borderStyle:"solid",borderColor:x.offBlack50,borderRadius:4,color:x.offBlack}};try{k.displayName="MathInput",k.__docgenInfo={description:"",displayName:"MathInput",props:{keypadElement:{defaultValue:null,description:"",name:"keypadElement",required:!1,type:{name:"KeypadAPI"}},onBlur:{defaultValue:null,description:"",name:"onBlur",required:!0,type:{name:"() => void"}},onChange:{defaultValue:null,description:"",name:"onChange",required:!0,type:{name:"(value: string, callback: any) => void"}},onFocus:{defaultValue:null,description:"",name:"onFocus",required:!0,type:{name:"() => void"}},style:{defaultValue:{value:"{}"},description:"",name:"style",required:!1,type:{name:"any"}},value:{defaultValue:{value:""},description:"",name:"value",required:!1,type:{name:"string"}}}}}catch{}var Q={exports:{}};function E(s){return function(){return s}}var y=function(){};y.thatReturns=E;y.thatReturnsFalse=E(!1);y.thatReturnsTrue=E(!0);y.thatReturnsNull=E(null);y.thatReturnsThis=function(){return this};y.thatReturnsArgument=function(s){return s};var St=y;function xt(s,t,e,o,n,i,a,c){if(!s){var r;if(t===void 0)r=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var d=[e,o,n,i,a,c],p=0;r=new Error(t.replace(/%s/g,function(){return d[p++]})),r.name="Invariant Violation"}throw r.framesToPop=1,r}}var Rt=xt,wt="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",Mt=wt,Ot=St,Nt=Rt,Ft=Mt,It=function(){function s(o,n,i,a,c,r){r!==Ft&&Nt(!1,"Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types")}s.isRequired=s;function t(){return s}var e={array:s,bool:s,func:s,number:s,object:s,string:s,symbol:s,any:s,arrayOf:t,element:s,instanceOf:t,node:s,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t};return e.checkPropTypes=Ot,e.PropTypes=e,e};Q.exports=It();var qt=Q.exports;const m=rt(qt),jt=m.shape({activate:m.func.isRequired,dismiss:m.func.isRequired,configure:m.func.isRequired,setCursor:m.func.isRequired,setKeyHandler:m.func.isRequired,getDOMNode:m.func.isRequired});export{k as M,jt as k};
